events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;

    upstream web_admin {
        server web-admin:3000;
    }

    upstream controller {
        server controller:8080;
    }

    upstream srs_http {
        server srs:8080;
    }

    server {
        listen 80;
        server_name localhost;

        # Web Admin UI
        location / {
            proxy_pass http://web_admin;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
        }

        # Controller API
        # Next.js proxies /api to controller, but we can also expose it directly if needed
        # Or let Next.js handle it. 
        # Since Next.js uses /api/auth, we must be careful not to shadow it.
        # But controller APIs are at /api/channels etc.
        # Next.js app/api routes are at /api/...
        # The Next.js app PROXIES requests to Controller.
        # So usually we just expose Next.js to the world.
        
        # However, for HLS playback from SRS:
        location /hls/ {
            proxy_pass http://srs_http/;
            add_header Access-Control-Allow-Origin *;
        }

        # If we want direct API access to controller (bypassing Next.js auth?), better NOT to expose it.
        # But for "production ready", we might keep it internal.
        # Let's just expose the Web Admin (Port 80) and SRS HLS.
    }
}
